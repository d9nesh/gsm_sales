<html>
  <head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <link href="https://canvasjs.com/assets/css/jquery-ui.1.11.2.min.css" rel="stylesheet" />
    <script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-ui.1.11.2.min.js"></script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
    <script>
      $(document).ready(function() {

        $.ajax({
          dataType: "json",
          url: "http://localhost:3000/api/chartdata",
          type : 'get',
          data: {asin:"B01F1CP0DS,B01MT8HASA", chart_day:5},
          contentType : 'application/json',
          success: function (data) {
            var data = data.data;
            var chartData =[];
            var profitData = [];
            var profitdateExist = [];
            var profitdatapoints = [];
            var dateExist = [];
            var datapoints = [];
            var temp = 0;
            for (var i = 0; i < data.length; i++) {
              sale_date = data[i].sale_date;
              if (dateExist[sale_date] != undefined){
                count = dateExist[sale_date];
                var pointupdate = true;
                var saleQuantity = 0;
                var profitQuantity = 0;

                var datalength = datapoints[sale_date].length;
                //console.log(datalength);
                if(datalength != undefined){
                  //console.log(datalength);
                  datalength = datalength - 1;
                  saleQuantity = parseInt(datapoints[sale_date][datalength].y);
                  profitQuantity = parseInt(profitdatapoints[sale_date][datalength].y);
                }

                for (var point=0 ; point < datapoints[sale_date].length; point++){
                   if(datapoints[sale_date][point].x == data[i].sale_hour){
                     pointupdate = false;
                     datapoints[sale_date][point].y = saleQuantity + parseInt(data[i].quantity);
                     profitdatapoints[sale_date][point].y = profitQuantity + parseInt(data[i].profit);
                   }
               }

                if(pointupdate){
                  datapoints[sale_date].push({
                    x:parseInt(data[i].sale_hour),
                    y:parseInt(data[i].quantity) + parseInt(saleQuantity)
                  });

                  profitdatapoints[sale_date].push({
                    x:parseInt(data[i].sale_hour),
                    y:parseInt(data[i].profit) + profitQuantity
                  });
               }
                chartData[count] = {
                    type: "line",
                    xValueType : "number",
                    name: sale_date,
                    dataPoints : datapoints[sale_date]
                }

                profitData[count] = {
                    type: "line",
                    xValueType : "number",
                    name: sale_date,
                    dataPoints : profitdatapoints[sale_date]
                }
              }else{

                dateExist[sale_date] = temp;
                datapoints[sale_date] = [];
                datapoints[sale_date].push({
                  x:parseInt(data[i].sale_hour),
                  y:data[i].quantity
                });

                profitdatapoints[sale_date] = [];
                profitdatapoints[sale_date].push({
                  x:parseInt(data[i].sale_hour),
                  y:data[i].profit
                });

                chartData[temp] = {
                  type: "line",
                  xValueType : "number",
                  name: sale_date,
                  dataPoints : [{
                    x:parseInt(data[i].sale_hour),
                    y:data[i].quantity
                  }]
                }

                profitData[temp] = {
                  type: "line",
                  xValueType : "number",
                  name: sale_date,
                  dataPoints : [{
                    x:parseInt(data[i].sale_hour),
                    y:data[i].profit
                  }]
                }

                temp = temp + 1;
              }
            }

            console.log("data length" + datapoints)
             //Better to construct options first and then pass it as a parameter
              var options1 = {
                  title: {
                       text: "GSM SALES: Daily Chart Sales"
                      },
                      animationEnabled: true,
                      axisY:{
                        title: "Sales"
                      },
                      data: chartData,
                };

                var profitOptions = {
                    title: {
                         text: "GSM SALES: Daily Chart Profit"
                        },
                        animationEnabled: true,
                        axisY:{
                          title: "Profit"
                        },
                        axisX:{
                          title: "Profit"
                        },
                        data: profitData,
            };

          $("#chartContainer1").CanvasJSChart(options1);
          $('#profitchartContainer').CanvasJSChart(profitOptions);
          }

        });


      });
    </script>
  </head>
  <body>
  <div class="container">
  <div class="container-fluid">
    <div class="row content">
      <div class="col-sm-12">
        <h1>Days to Chart </h1>
      </div>

      <div class="col-sm-12">
        <form class="form-inline" action="/chart" method="post">
          <div class="form-group">
            <label for="segment">Business Segment:</label>
            <select class="form-control" id="segment" name="segment">
              <option>Amazon</option>
              <option>Private Label</option>
              <option>Wholesale</option>
            </select>
          </div>
          <div class="form-group">
            <label for="asin">ASIN:</label>
            <input type="search" class="form-control" id="asin" name="asin" placeholder="Search">
          </div>
          <div class="form-group">
            <label for="chart">Day To Chart:</label>
            <input type="number" class="form-control" id="chart" name="chart" min="1" max="10" value="5">
          </div>
          <input type="hidden" class="asin-values" name="asin_values" value="" />
          <button type="submit" id="submit-form" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">Generate Chart</button>
        </form>
      </div>

      <div class="modal fade" id="myModal" role="dialog">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h2 class="modal-title">Daily Chart</h2>
          </div>
          <div class="modal-body">

            <div class="col-sm-12">
              <div class="col-sm-6">
                <div id="chartContainer1" style="height: 300px; width: 100%;"></div>
              </div>
              <div class="col-sm-6">
                <div id="profitchartContainer" style="height: 300px; width: 100%;"></div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


    </div>
  </div>
  </div>
  </body>
</html>
